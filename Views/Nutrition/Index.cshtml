@model List<HealthFitness.DTOs.NutritionDto>
@{
    ViewData["Title"] = "Nutrition";
    var groupedNutrition = Model.OrderByDescending(n => n.Time).GroupBy(n => DateTime.Today);
    var mealTypes = new[] { "Breakfast", "Lunch", "Dinner", "Snack" };
}

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="bi bi-check-circle me-2"></i>@TempData["SuccessMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="bi bi-exclamation-triangle me-2"></i>@TempData["ErrorMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="fw-bold mb-1">Nutrition Log</h2>
        <p class="text-muted mb-0">Track your meals and calorie intake</p>
    </div>
    <a asp-action="Create" class="btn btn-primary">
        <i class="bi bi-plus-circle me-2"></i>Log New Meal
    </a>
</div>

@if (Model.Any())
{
    <div class="row mb-3">
        <div class="col-md-12">
            <div class="card border-0 shadow-sm mb-3">
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-3">
                            <div class="p-2">
                                <h6 class="text-muted small mb-1">Total Meals</h6>
                                <h4 class="fw-bold mb-0 text-primary">@Model.Count</h4>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="p-2">
                                <h6 class="text-muted small mb-1">Total Calories</h6>
                                <h4 class="fw-bold mb-0 text-success">@Model.Sum(n => n.Calories).ToString("F0")</h4>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="p-2">
                                <h6 class="text-muted small mb-1">Avg per Meal</h6>
                                <h4 class="fw-bold mb-0 text-info">@(Model.Count > 0 ? (Model.Sum(n => n.Calories) / Model.Count).ToString("F0") : "0")</h4>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="p-2">
                                <h6 class="text-muted small mb-1">Days Tracked</h6>
                                <h4 class="fw-bold mb-0 text-warning">@groupedNutrition.Count()</h4>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    @foreach (var group in groupedNutrition)
    {
        var dailyCalories = group.Sum(n => n.Calories);
        var mealsByType = group.GroupBy(n => n.MealType);
        
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-light border-0 py-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="fw-bold mb-0">
                            <i class="bi bi-clock me-2 text-success"></i>
                            Today's Meals
                        </h5>
                        <small class="text-muted">
                            @group.Count() @(group.Count() == 1 ? "meal" : "meals") logged
                        </small>
                    </div>
                    <div class="text-end">
                        <span class="badge bg-success fs-6">@dailyCalories.ToString("F0") calories</span>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    @foreach (var mealType in mealTypes)
                    {
                        var meals = group.Where(n => n.MealType == mealType).ToList();
                        if (meals.Any())
                        {
                            var mealTypeCalories = meals.Sum(m => m.Calories);
                            var mealTypeIcon = mealType switch
                            {
                                "Breakfast" => "sunrise",
                                "Lunch" => "sun",
                                "Dinner" => "moon",
                                _ => "cup"
                            };
                            
                            <div class="col-md-6 col-lg-3">
                                <div class="card border h-100">
                                    <div class="card-body p-3">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <h6 class="fw-bold mb-0">
                                                <i class="bi bi-@mealTypeIcon me-1 text-warning"></i>@mealType
                                            </h6>
                                            <span class="badge bg-warning text-dark">@mealTypeCalories.ToString("F0")</span>
                                        </div>
                                        <ul class="list-unstyled mb-0 small">
                                            @foreach (var meal in meals)
                                            {
                                                <li class="mb-2 pb-2 border-bottom">
                                                    <div class="d-flex justify-content-between align-items-start">
                                                        <div class="flex-grow-1">
                                                            <div class="fw-semibold">@meal.FoodName</div>
                                                            <div class="text-muted small">
                                                                <i class="bi bi-clock me-1"></i>@meal.Time.ToString(@"hh\:mm")
                                                                â€¢ @meal.Calories.ToString("F0") cal
                                                                @if (meal.Protein.HasValue || meal.Carbs.HasValue || meal.Fat.HasValue)
                                                                {
                                                                    <span class="ms-2">
                                                                        @if (meal.Protein.HasValue) { <text>P: @meal.Protein.Value.ToString("F1")g</text> }
                                                                        @if (meal.Carbs.HasValue) { <text>C: @meal.Carbs.Value.ToString("F1")g</text> }
                                                                        @if (meal.Fat.HasValue) { <text>F: @meal.Fat.Value.ToString("F1")g</text> }
                                                                    </span>
                                                                }
                                                            </div>
                                                        </div>
                                                        <div class="btn-group-vertical btn-group-sm">
                                                            <a asp-action="Edit" asp-route-id="@meal.Id" class="btn btn-sm btn-outline-warning" title="Edit">
                                                                <i class="bi bi-pencil"></i>
                                                            </a>
                                                            <form asp-action="Delete" asp-route-id="@meal.Id" method="post" class="d-inline">
                                                                <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Are you sure?')" title="Delete">
                                                                    <i class="bi bi-trash"></i>
                                                                </button>
                            </form>
                                                        </div>
                                                    </div>
                                                </li>
                                            }
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        }
                    }
                </div>
            </div>
    </div>
    }
}
else
{
    <div class="card border-0 shadow-sm">
        <div class="card-body text-center py-5">
            <i class="bi bi-egg-fried text-muted" style="font-size: 4rem;"></i>
            <h5 class="mt-3 mb-2">No Meals Logged Yet</h5>
            <p class="text-muted mb-4">Start tracking your nutrition by logging your first meal.</p>
            <a asp-action="Create" class="btn btn-primary">
                <i class="bi bi-plus-circle me-2"></i>Log Your First Meal
            </a>
        </div>
    </div>
}

